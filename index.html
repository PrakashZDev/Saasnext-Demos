<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta Ads Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;
        let allData = [];
        let charts = {}; // Store chart instances

        // Utility function to get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // --- Configuration & Default Data ---
        // TODAY_DATE is the actual current calendar date, used for the input field default
        const TODAY_DATE = getTodayDateString(); 
        // STATIC_DEFAULT_DATE is the fixed date from the user's data image
        const STATIC_DEFAULT_DATE = '2025-10-18'; 
        const CURRENCY_SYMBOL = '₹';
        const CAMPAIGN_DAILY_BUDGET = 350.00; 

        // Default data uses the specific static date and metrics from the user's image
        const DEFAULT_AD_DATA = {
            date: STATIC_DEFAULT_DATE, 
            reach: 2317, // Accounts Center accounts
            impressions: 3764, // Total Impressions
            clicks: 245, // Link clicks
            conversions: 10, // Placeholder, as not specified in the image
            cost: 138.35,
            lastUpdated: new Date().toISOString()
        };
        // --------------------------------------------------

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-meta-ads-analytics-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Core Initialization Function ---
        function initializeAppAndData() {
            document.getElementById('date').value = TODAY_DATE;

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Authenticate and set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = 'User ID: ' + userId;
                        fetchData();
                    } else {
                        // Sign in if not authenticated
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication Error:", error);
                            isAuthReady = true; 
                            document.getElementById('user-id-display').textContent = 'Auth Failed';
                        }
                    }
                });
            } else {
                // FIX: Fallback for local execution when Canvas environment variables are missing
                document.getElementById('user-id-display').textContent = 'Running in Local Mode (Offline)';
                
                // Generate mock data for visualization, using the static default data point
                const mockData = [
                    DEFAULT_AD_DATA, // 2025-10-18 with specific metrics
                    // Adding subsequent days for a meaningful trend line
                    { date: '2025-10-19', reach: 3000, impressions: 5000, clicks: 350, conversions: 15, cost: 200.00, lastUpdated: new Date().toISOString() },
                    { date: '2025-10-20', reach: 1500, impressions: 2500, clicks: 150, conversions: 5, cost: 80.50, lastUpdated: new Date().toISOString() }
                ];
                
                // Sort and render mock data
                mockData.sort((a, b) => new Date(a.date) - new Date(b.date));
                allData = mockData;
                
                renderDashboard(allData);

                // Display warning
                showToast("Firebase config missing. Displaying sample data in read-only mode.", 'bg-yellow-600');
            }
        }
        
        // **CRITICAL FIX:** Ensure initialization runs only after the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', initializeAppAndData);

        /**
         * Handles form submission and saves data to Firestore.
         */
        window.saveAdData = async function(event) {
            event.preventDefault();

            if (!isAuthReady || !db || userId === 'loading') {
                showToast("Error: Database not ready or user ID is loading.", 'bg-red-500');
                return;
            }

            const formData = new FormData(document.getElementById('data-entry-form'));
            const data = {
                date: formData.get('date'),
                reach: parseInt(formData.get('reach')) || 0,
                impressions: parseInt(formData.get('impressions')) || 0,
                clicks: parseInt(formData.get('clicks')) || 0,
                conversions: parseInt(formData.get('conversions')) || 0,
                cost: parseFloat(formData.get('cost')) || 0.0,
                lastUpdated: new Date().toISOString()
            };

            const docPath = `artifacts/${appId}/users/${userId}/meta_ads_data`;
            const docRef = doc(db, docPath, data.date);
            
            try {
                await setDoc(docRef, data);
                showToast("Data saved successfully for " + data.date, 'bg-green-500');
            } catch (error) {
                console.error("Error saving document:", error);
                showToast("Error saving data: " + error.message, 'bg-red-500');
            }
        }
        
        /**
         * Inserts the static default data point into Firestore if the user's collection is empty.
         */
        async function insertDefaultData() {
            if (!db || !userId || userId === 'loading') return;

            const docPath = `artifacts/${appId}/users/${userId}/meta_ads_data`;
            const docRef = doc(db, docPath, DEFAULT_AD_DATA.date);
            
            try {
                await setDoc(docRef, DEFAULT_AD_DATA);
            } catch (error) {
                console.error("Error inserting default document:", error);
            }
        }

        /**
         * Sets up real-time listener for ad data and updates the dashboard.
         */
        function fetchData() {
            if (!db || !userId || userId === 'loading') return;

            const collectionPath = `artifacts/${appId}/users/${userId}/meta_ads_data`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                const fetchedData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedData.push(data);
                });
                
                // If no data exists, insert the default data point (2025-10-18)
                if (snapshot.empty && isAuthReady) {
                    console.log("No existing data found. Inserting static default data.");
                    insertDefaultData();
                }

                // Sort data by date for chronological chart display
                allData = fetchedData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Pre-fill form with latest data point (if any) or today's date
                if (allData.length > 0) {
                    const latestData = allData[allData.length - 1];
                    document.getElementById('date').value = TODAY_DATE; // Always default to today's date for entry
                    // You could potentially pre-fill the last entered metrics here if desired, 
                    // but usually, input fields are left blank for new entries.
                } else {
                    document.getElementById('date').value = TODAY_DATE;
                }


                renderDashboard(allData);
            }, (error) => {
                console.error("Error fetching data:", error);
                showToast("Error loading data from Firestore.", 'bg-red-500');
            });
        }

        // --- Dashboard and Chart Rendering ---

        /**
         * Calculates key performance indicators (KPIs) from the aggregated data.
         */
        function calculateKPIs(data) {
            const total = data.reduce((acc, curr) => {
                acc.totalReach += curr.reach;
                acc.totalImpressions += curr.impressions;
                acc.totalClicks += curr.clicks;
                acc.totalConversions += curr.conversions;
                acc.totalCost += curr.cost;
                return acc;
            }, { totalReach: 0, totalImpressions: 0, totalClicks: 0, totalConversions: 0, totalCost: 0 });

            // Calculate metrics
            const CTR = total.totalImpressions > 0 ? (total.totalClicks / total.totalImpressions) * 100 : 0;
            const CostPerResult = total.totalClicks > 0 ? (total.totalCost / total.totalClicks) : 0;
            
            return {
                totalReach: total.totalReach.toLocaleString(),
                CostPerResult: CostPerResult > 0 ? `${CURRENCY_SYMBOL}${CostPerResult.toFixed(2)}` : 'N/A',
                DailyBudget: `${CURRENCY_SYMBOL}${CAMPAIGN_DAILY_BUDGET.toFixed(2)}`,
                totalImpressions: total.totalImpressions.toLocaleString(),
                totalClicks: total.totalClicks.toLocaleString(),
                totalCost: `${CURRENCY_SYMBOL}${total.totalCost.toFixed(2).toLocaleString()}`, 
                CTR: `${CTR.toFixed(2)}%`,
            };
        }

        /**
         * Renders the KPI cards and triggers chart rendering.
         */
        function renderDashboard(data) {
            const kpis = calculateKPIs(data);
            const kpiContainer = document.getElementById('kpi-container');
            
            // Render KPI Strategic View
            kpiContainer.innerHTML = Object.entries(kpis).map(([key, value]) => `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 flex flex-col justify-between">
                    <p class="text-xs font-semibold text-gray-500 uppercase">${key.replace(/([A-Z])/g, ' $1').trim()}</p>
                    <p class="text-3xl font-extrabold text-indigo-700 mt-1">${value}</p>
                </div>
            `).join('');

            // Render Charts
            renderCharts(data);
        }

        /**
         * Renders the Chart.js visualizations.
         */
        function renderCharts(data) {
            const labels = data.map(d => d.date);
            const clicksData = data.map(d => d.clicks);
            const costData = data.map(d => d.cost);
            const conversionsData = data.map(d => d.conversions);

            // --- 1. Graph View (Clicks and Conversions Trend Line) ---
            const ctxGraph = document.getElementById('lineGraph')?.getContext('2d');
             if (!ctxGraph) return; // Exit if context not found
            
            if (charts.lineGraph) charts.lineGraph.destroy(); // Destroy previous instance
            charts.lineGraph = new Chart(ctxGraph, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Link Clicks',
                        data: clicksData,
                        borderColor: '#4f46e5', // Indigo
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5, // ADDED: Increase point size for emphasis
                        pointBackgroundColor: '#ffffff', // ADDED: White fill for contrast
                        pointBorderWidth: 2, // ADDED: Thicker border
                    }, {
                        label: 'Conversions',
                        data: conversionsData,
                        borderColor: '#10b981', // Emerald
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // --- 2. Bar Chart View (Daily Cost/Reach Breakdown) ---
            const ctxBar = document.getElementById('barChart')?.getContext('2d');
            if (!ctxBar) return; // Exit if context not found

            if (charts.barChart) charts.barChart.destroy(); // Destroy previous instance
            charts.barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Daily Cost (${CURRENCY_SYMBOL})`,
                        data: costData,
                        backgroundColor: '#f97316', // Orange
                        yAxisID: 'y'
                    }, {
                        label: 'Daily Reach',
                        data: data.map(d => d.reach),
                        backgroundColor: '#6366f1', // Violet
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: `Cost (INR ${CURRENCY_SYMBOL})` },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Reach' },
                            grid: { drawOnChartArea: false },
                            ticks: { callback: (val) => val.toLocaleString() } 
                        }
                    }
                }
            });
        }

        // --- Utility Functions ---

        /**
         * Displays a temporary toast notification.
         */
        function showToast(message, bgColor) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-3 rounded-xl shadow-xl text-white ${bgColor} transition-opacity duration-300 opacity-100 z-50`;
            setTimeout(() => {
                toast.className = `fixed bottom-5 right-5 p-3 rounded-xl shadow-xl text-white ${bgColor} transition-opacity duration-300 opacity-0 z-50`;
            }, 3000);
        }

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .h-80 {
            height: 20rem; /* 320px */
        }
        /* Custom styling for input fields to match dashboard aesthetics */
        .data-input {
            @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-700">Meta Ads Analytics Sim (INR)</h1>
            <p id="user-id-display" class="text-xs text-gray-500 truncate"></p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Manual Data Entry Section (Re-added) -->
        <section class="mb-10 bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Manual Data Entry (Daily Metrics)</h2>
            <form id="data-entry-form" onsubmit="saveAdData(event)" class="space-y-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                    
                    <!-- Date -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="date" name="date" required class="data-input">
                    </div>
                    
                    <!-- Reach -->
                    <div>
                        <label for="reach" class="block text-sm font-medium text-gray-700">Reach</label>
                        <input type="number" id="reach" name="reach" required class="data-input" placeholder="e.g., 2317">
                    </div>

                    <!-- Impressions -->
                    <div>
                        <label for="impressions" class="block text-sm font-medium text-gray-700">Impressions</label>
                        <input type="number" id="impressions" name="impressions" required class="data-input" placeholder="e.g., 3764">
                    </div>

                    <!-- Link Clicks -->
                    <div>
                        <label for="clicks" class="block text-sm font-medium text-gray-700">Link Clicks</label>
                        <input type="number" id="clicks" name="clicks" required class="data-input" placeholder="e.g., 245">
                    </div>

                    <!-- Conversions (Placeholder) -->
                    <div>
                        <label for="conversions" class="block text-sm font-medium text-gray-700">Conversions</label>
                        <input type="number" id="conversions" name="conversions" required class="data-input" placeholder="e.g., 10">
                    </div>

                    <!-- Cost -->
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-700">Cost (₹)</label>
                        <input type="number" step="0.01" id="cost" name="cost" required class="data-input" placeholder="e.g., 138.35">
                    </div>
                </div>

                <div class="pt-4 flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-xl shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Save Daily Data
                    </button>
                </div>
            </form>
        </section>


        <!-- Strategic View Section (KPIs) -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Strategic View: Key Performance Indicators</h2>
            <!-- KPI Grid is fully responsive: 2 columns on mobile, 3 on tablet, 6 on desktop -->
            <div id="kpi-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <!-- KPI Cards will be injected here -->
                <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 animate-pulse h-28"></div>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 animate-pulse h-28"></div>
                <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 animate-pulse h-28"></div>
            </div>
        </section>

        <!-- Graph and Bar Chart Section -->
        <!-- Charts display in columns starting on medium (tablet) screens -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Graph View: Clicks & Conversion Trend</h2>
                <div class="h-80">
                    <canvas id="lineGraph"></canvas>
                </div>
            </div>

            <!-- Bar Chart View (Breakdown) -->
            <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Bar Chart View: Daily Cost & Reach</h2>
                <div class="h-80">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </section>
        
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 p-3 rounded-xl shadow-xl text-white bg-green-500 transition-opacity duration-300 opacity-0 z-50">
        <!-- Message here -->
    </div>

</body>
</html>
